name: Optimized BPB Obfuscate Workflow 
 
on:
  push:
    branches: [main]
  schedule:
    - cron: "0 1 * * *"
 
permissions:
  contents: write 
 
jobs:
  build:
    runs-on: ubuntu-latest 
    env:
      NODE_VERSION: "20"  # 固定 LTS 版本 
    steps:
      - name: Checkout code 
        uses: actions/checkout@v4 
 
      - name: Cache Node modules 
        uses: actions/cache@v3 
        with:
          path: ~/.npm 
          key: ${{ runner.os  }}-node-${{ hashFiles('**/package-lock.json')  }}
 
      - name: Setup Node.js  
        uses: actions/setup-node@v4 
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
 
      - name: Install dependencies 
        run: npm install -g javascript-obfuscator@4.0.0  # 固定版本 
 
      - name: Download source 
        run: wget -O origin.js  https://raw.githubusercontent.com/.../unobfuscated-worker.js  
 
      - name: Optimized obfuscation 
        run: |
          javascript-obfuscator origin.js  --output _worker.js  \
          --compact true \
          --control-flow-flattening true \
          --control-flow-flattening-threshold 0.5 \  # 降低阈值 
          --dead-code-injection false \  # 禁用高危选项 
          --identifier-names-generator hexadecimal \
          --rename-globals true \
          --string-array true \
          --string-array-encoding 'base64' \  # 替换 rc4 降低复杂度 
          --string-array-threshold 0.75 \
          --transform-object-keys false \  # 禁用非必要选项 
          --unicode-escape-sequence false 
 
      - name: Commit changes 
        uses: stefanzweifel/git-auto-commit-action@v5 
        with:
          branch: main 
          commit_message: ':zap: Optimized BPB obfuscation'
